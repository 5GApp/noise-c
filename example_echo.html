<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Noise-C: Using Noise-C: Client/Server Echo Example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Noise-C
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Using Noise-C: Client/Server Echo Example </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#example_echo_client">Creating a Noise-C client application</a><ul><li class="level2"><a href="#example_echo_create_handshake">Creating the HandshakeState</a></li>
<li class="level2"><a href="#example_echo_setting_keys">Setting keys</a></li>
<li class="level2"><a href="#example_echo_run_handshake">Running the handshake phase</a></li>
<li class="level2"><a href="#example_echo_run_transport">Running the data transport phase</a></li>
</ul>
</li>
<li class="level1"><a href="#example_echo_using">Using the echo example</a><ul><li class="level2"><a href="#example_echo_keygen">Generating keys</a></li>
<li class="level2"><a href="#example_echo_start_server">Starting an echo server</a></li>
<li class="level2"><a href="#example_echo_start_client">Running the echo client</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>This page describes how to use Noise-C to create a simple client/server echo system. This example uses the same wire protocol as the echo example from <a href="https://github.com/centromere/cacophony#example-code">cacophony</a>, for testing interoperability between Noise implementations.</p>
<p>The source code for the example is under the <code>examples/echo</code> directory in the Noise-C repository. There are three programs that make up the example: <code>echo-client</code>, <code>echo-server</code>, and <code>echo-keygen</code>. Here we describe the main points of the client code to demonstrate how to use Noise-C. The server side is similar.</p>
<h1><a class="anchor" id="example_echo_client"></a>
Creating a Noise-C client application</h1>
<h2><a class="anchor" id="example_echo_create_handshake"></a>
Creating the HandshakeState</h2>
<p>The first step in using a HandshakeState is to create it with either the <a class="el" href="group__handshakestate.html#ga0e6235ea4b4c8c434417172a764bf76c" title="Creates a new HandshakeState object by protocol name. ">noise_handshakestate_new_by_name()</a> or <a class="el" href="group__handshakestate.html#gab0b47aa4e0577b68ad90848565c00a8b" title="Creates a new HandshakeState object by protocol identifier. ">noise_handshakestate_new_by_id()</a> function:</p>
 <div class="fragment"><div class="line">    <a class="code" href="internal_8h.html#structNoiseHandshakeState__s">NoiseHandshakeState</a> *handshake;</div>
<div class="line">    err = <a class="code" href="group__handshakestate.html#ga0e6235ea4b4c8c434417172a764bf76c">noise_handshakestate_new_by_name</a></div>
<div class="line">        (&amp;handshake, protocol, <a class="code" href="group__roles.html#gad6265b662278a9f9b1523c55b6d0080d">NOISE_ROLE_INITIATOR</a>);</div>
<div class="line">    <span class="keywordflow">if</span> (err != <a class="code" href="group__errors.html#ga132b97fab62750f9f1e665c3783455c4">NOISE_ERROR_NONE</a>) {</div>
<div class="line">        <a class="code" href="group__error__reports.html#ga0885ea578e579336e85716e7b58e4aa3">noise_perror</a>(protocol, err);</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
</div><!-- fragment --></p>
<p>Here the "protocol" variable is the name of the Noise protocol, such as "Noise_XX_25519_ChaChaPoly_BLAKE2s". Because we are writing a client, the role is <a class="el" href="group__roles.html#gad6265b662278a9f9b1523c55b6d0080d">NOISE_ROLE_INITIATOR</a>. The server side uses <a class="el" href="group__roles.html#ga1f681376eb63a3f459b1c20a291d17b8">NOISE_ROLE_RESPONDER</a> instead.</p>
<p>If an error occurs, the <a class="el" href="group__error__reports.html#ga0885ea578e579336e85716e7b58e4aa3" title="Prints a descriptive string for an error to stderr. ">noise_perror()</a> function can be used to print a simple message to the standard error output in the same way as the perror() function in C. If you want to report errors through some means other than the standard error output, you can use <a class="el" href="group__error__reports.html#ga6dd658a63b1d30f754f12f0eb69f07e0" title="Gets the descriptive string for an error code. ">noise_strerror()</a> to obtain the error string directly.</p>
<p>For the rest of this page we will elide the calls to <a class="el" href="group__error__reports.html#ga0885ea578e579336e85716e7b58e4aa3" title="Prints a descriptive string for an error to stderr. ">noise_perror()</a> to make it easier to understand the code snippets. Error handling is very important. Noise sessions can fail for any number of reasons and forgetting to check an error return could lead the application to continue operating when it should stop.</p>
<p>When you no longer need the HandshakeState, the memory should be returned to the system with <a class="el" href="group__handshakestate.html#ga1ee4331d10a6c28bd336bfdf1017346d" title="Frees a HandshakeState object after destroying all sensitive material. ">noise_handshakestate_free()</a>:</p>
 <div class="fragment"><div class="line">    <a class="code" href="group__handshakestate.html#ga1ee4331d10a6c28bd336bfdf1017346d">noise_handshakestate_free</a>(handshake);</div>
</div><!-- fragment --></p>
<h2><a class="anchor" id="example_echo_setting_keys"></a>
Setting keys</h2>
<p>TBD</p>
<h2><a class="anchor" id="example_echo_run_handshake"></a>
Running the handshake phase</h2>
<p>TBD</p>
<h2><a class="anchor" id="example_echo_run_transport"></a>
Running the data transport phase</h2>
<p>TBD</p>
<h1><a class="anchor" id="example_echo_using"></a>
Using the echo example</h1>
<p>This section describes how to use the echo example: how to generate keys, how to start an echo server running, and how to connect to it using an echo client.</p>
<h2><a class="anchor" id="example_echo_keygen"></a>
Generating keys</h2>
<p>The echo example uses a very simple key format. Private key files are binary data containing the 32 or 56 bytes of the private key, for Curve25519 and Curve448 respectively. Public key files contain the base64 encoding of the 32 or 56 byte public key values.</p>
<p>The <code>echo-keygen</code> example can be used to generate new keys or you can use the keys from cacophony. To generate a new key for Curve25519, you would invoke the key generator as follows:</p>
<div class="fragment"><div class="line">echo-keygen 25519 client_key_25519 client_key_25519.pub</div>
</div><!-- fragment --><p>The arguments are the curve type ("25519" or "448"), the name of the private key file, and the name of the public key file.</p>
<p>The server needs a full set of keys, so here's how to generate them all:</p>
<div class="fragment"><div class="line">echo-keygen 25519 client_key_25519 client_key_25519.pub</div>
<div class="line">echo-keygen 25519 server_key_25519 server_key_25519.pub</div>
<div class="line">echo-keygen 448 client_key_448 client_key_448.pub</div>
<div class="line">echo-keygen 448 server_key_448 server_key_448.pub</div>
</div><!-- fragment --><h2><a class="anchor" id="example_echo_start_server"></a>
Starting an echo server</h2>
<p>A new echo server can be started with the following command:</p>
<div class="fragment"><div class="line">echo-server --key-dir=../keys 7000</div>
</div><!-- fragment --><p>The server will look in <code>key-dir</code> for the keys that were generated earlier. If <code>&ndash;key-dir</code> is omitted, it defaults to the current directory.</p>
<p>The pre-shared key value is loaded from the "psk" file in the key directory. It is assumed to be a 32 byte value encoded in base64. Pre-shared keys are only used if the client selects them.</p>
<p>The final argument is the port number for the server to bind to.</p>
<h2><a class="anchor" id="example_echo_start_client"></a>
Running the echo client</h2>
<p>To use the client, specify the Noise protocol name, server hostname, and server port number on the command-line:</p>
<div class="fragment"><div class="line">echo-client Noise_NN_25519_AESGCM_SHA256 hostname 7000</div>
</div><!-- fragment --><p>In this case we are using the "NN" pattern which does not require any additional local or remote static keys. If keys are required, they can be provided via options:</p>
<div class="fragment"><div class="line">echo-client --client-<span class="keyword">private</span>-key=client_key_448 \</div>
<div class="line">            --server-<span class="keyword">public</span>-key=server_key_448.pub \
            Noise_KK_448_ChaChaPoly_BLAKE2b hostname 7000</div>
<div class="line"></div>
<div class="line">echo-client --client-<span class="keyword">private</span>-key=client_key_448 \</div>
<div class="line">            --server-<span class="keyword">public</span>-key=server_key_448.pub \</div>
<div class="line">            --psk=pskfile \</div>
<div class="line">            NoisePSK_KK_448_ChaChaPoly_BLAKE2b hostname 7000</div>
</div><!-- fragment --><p>After performing the handshake, the client reads lines of text from its standard input and sends them to the server. After each line, the client will wait for a packet from the server and then will write its contents to standard output prefixed by <code>Received</code>:</p>
<div class="fragment"><div class="line">Hello!</div>
<div class="line">Received: Hello!</div>
<div class="line">What day is it?</div>
<div class="line">Received: What day is it?</div>
</div><!-- fragment --><p>If the keys supplied to the client do not match those used by the server, the connection will abort with a "MAC failure".</p>
<p>The <code>&ndash;padding</code> option can be supplied to cause the client to pad all outgoing messages to a uniform size with random data. The padding will be stripped when the echo returns from the server. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Apr 22 2016 15:51:04 for Noise-C by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
